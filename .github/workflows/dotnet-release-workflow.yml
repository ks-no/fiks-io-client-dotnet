permissions:
  contents: read
  checks: write

name: .NET Library Build and Release Pipeline

on:
  workflow_dispatch:
    inputs:
      isRelease:
        description: 'Skal prosjektet releases? (Release build?)'
        type: boolean
        required: false
        default: false
      pushToNugetOrg:
        description: 'Skal artifaktet pushes til nuget.org? (Only for pre-release)'
        type: boolean
        required: false
        default: false
      specifiedVersion:
        description: 'Hva er det nye versjonsnummeret (X.X.X)? (Leave empty for current version)'
        required: false
        default: ''
      releaseNotes:
        description: 'Hva er endret i denne releasen? (Release notes)'
        required: false
        default: 'Ingen endringer utfÃ¸rt'
      reviewer:
        description: 'Hvem har gjort review? (Reviewer name)'
        required: false
        default: 'Endringene krever ikke review'
  push:
    branches:
      - original-delete-me
  pull_request:
    branches:
      - original-delete-me

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  initialize:
    name: Initialize Build
    runs-on: ubuntu-latest
    outputs:
      current-version: ${{ steps.version.outputs.current-version }}
      next-version: ${{ steps.version.outputs.next-version }}
      full-version: ${{ steps.version.outputs.full-version }}
      version-suffix: ${{ steps.version.outputs.version-suffix }}
      build-opts: ${{ steps.version.outputs.build-opts }}
      is-release: ${{ steps.version.outputs.is-release }}
      repo-name: ${{ steps.repo.outputs.repo-name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Extract repository name
        id: repo
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          echo "repo-name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "Repository: $REPO_NAME"

      - name: Calculate version information
        id: version
        run: |
          find_version() {
            for file in $(find . -name "*.csproj" -not -path "*/Test*" -not -path "*/Example*"); do
              version=$(grep -oP '(?<=<VersionPrefix>)[^<]+' "$file" | head -1)
              if [ -n "$version" ]; then
                echo "$version"
                return
              fi
            done
            echo ""
          }
          
          CURRENT_VERSION="${{ github.event.inputs.specifiedVersion }}"
          if [ -z "$CURRENT_VERSION" ]; then
            CURRENT_VERSION=$(find_version)
          fi
          
          if [ -z "$CURRENT_VERSION" ]; then
            echo "Error: No version found in csproj files"
            exit 1
          fi
          
          echo "Current version: $CURRENT_VERSION"
          echo "current-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Calculate next version
          IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
          NEXT_VERSION="${major}.${minor}.$((patch + 1))"
          echo "next-version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Next version: $NEXT_VERSION"
          
          # Determine if this is a release
          IS_RELEASE="${{ github.event.inputs.isRelease }}"
          if [ "$IS_RELEASE" != "true" ]; then
            IS_RELEASE="false"
          fi
          echo "is-release=$IS_RELEASE" >> $GITHUB_OUTPUT
          
          # Calculate version suffix for pre-release builds
          if [ "$IS_RELEASE" = "false" ]; then
            BRANCH_NAME="${GITHUB_REF_NAME}"
            NORMALIZED_BRANCH=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]//g' | cut -c1-15)
            VERSION_SUFFIX="alpha.${NORMALIZED_BRANCH}.${GITHUB_RUN_NUMBER}"
            FULL_VERSION="${CURRENT_VERSION}-${VERSION_SUFFIX}"
            BUILD_OPTS="--version-suffix ${VERSION_SUFFIX}"
          else
            VERSION_SUFFIX=""
            FULL_VERSION="${CURRENT_VERSION}"
            BUILD_OPTS=""
          fi
          
          echo "version-suffix=$VERSION_SUFFIX" >> $GITHUB_OUTPUT
          echo "full-version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "build-opts=$BUILD_OPTS" >> $GITHUB_OUTPUT
          
          echo "Full version: $FULL_VERSION"
          echo "Version suffix: $VERSION_SUFFIX"
          echo "Build options: $BUILD_OPTS"

  build-linux:
    name: Build and Test (Linux)
    needs: initialize
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'

      - name: Display build information
        run: |
          echo "Building version: ${{ needs.initialize.outputs.full-version }}"
          echo "Is release: ${{ needs.initialize.outputs.is-release }}"
          echo "Repository: ${{ needs.initialize.outputs.repo-name }}"
          dotnet --info

      - name: Add Artifactory NuGet source
        env:
          NUGET_ALL_REPO: https://artifactory.fiks.ks.no/artifactory/api/nuget/nuget-all
        run: |
          dotnet nuget add source $NUGET_ALL_REPO -n nuget-all \
            -u ${{ secrets.ARTIFACTORY_USERNAME }} \
            -p ${{ secrets.ARTIFACTORY_PASSWORD }} \
            --store-password-in-clear-text
        continue-on-error: true

      - name: Restore dependencies
        run: dotnet restore --verbosity normal

      - name: Build Debug
        run: |
          dotnet build --configuration Debug \
            --no-restore \
            --no-incremental \
            --nologo \
            ${{ needs.initialize.outputs.build-opts }}

      - name: Build Release
        run: |
          dotnet build --configuration Release \
            --no-restore \
            --no-incremental \
            --nologo \
            --verbosity detailed \
            ${{ needs.initialize.outputs.build-opts }}

      - name: Run tests
        run: |
          dotnet test \
            --configuration Release \
            --no-restore \
            --no-build \
            --logger "trx;LogFileName=results.trx" \
            --verbosity normal

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: .NET Tests (Linux)
          path: '**/*.trx'
          reporter: dotnet-trx
          fail-on-error: false

      - name: Generate SBOM
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          dotnet new tool-manifest --force
          dotnet tool install CycloneDX
          SLNFILE=$(find . -name "*.sln" | head -1)
          if [ -n "$SLNFILE" ]; then
            dotnet tool run dotnet-CycloneDX \
              -o . \
              -dgl \
              -sv ${{ needs.initialize.outputs.full-version }} \
              -j -d \
              -t "$SLNFILE"
          fi

      - name: Upload SBOM
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: bom.json
          if-no-files-found: ignore

      - name: Sign NuGet packages
        env:
          CODE_SIGN_CERT_B64: ${{ secrets.CODE_SIGN_CERT_BASE64 }}
          CODE_SIGN_KEY: ${{ secrets.CODE_SIGN_PFX_PASS }}
          TIMESTAMP_URL: http://timestamp.digicert.com
        run: |
          # Decode certificate
          echo "$CODE_SIGN_CERT_B64" | base64 --decode > codesign.pfx
          
          # Sign all nupkg files
          for pkg in $(find . -name "*.nupkg" -path "*/Release/*"); do
            echo "Signing $pkg"
            dotnet nuget sign "$pkg" \
              --timestamper $TIMESTAMP_URL \
              --certificate-path codesign.pfx \
              --certificate-password $CODE_SIGN_KEY \
              -v detailed
          done
          
          # Clean up certificate
          rm -f codesign.pfx

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: |
            **/Release/*.nupkg
            **/Release/*.snupkg
          if-no-files-found: error

      - name: Push to Artifactory
        run: |
          for pkg in $(find . -name "*.nupkg" -path "*/Release/*"); do
            echo "Pushing $pkg to Artifactory"
            dotnet nuget push "$pkg" \
              -s nuget-all \
              --skip-duplicate
          done

      - name: Remove Artifactory NuGet source
        if: always()
        run: dotnet nuget remove source nuget-all
        continue-on-error: true

  build-windows:
    name: Build and Test (Windows)
    needs: initialize
    runs-on: windows-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Display build information
        run: |
          Write-Host "Building version: ${{ needs.initialize.outputs.full-version }}"
          Write-Host "Is release: ${{ needs.initialize.outputs.is-release }}"
          dotnet --info

      - name: Add Artifactory NuGet source
        shell: pwsh
        env:
          NUGET_ALL_REPO: https://artifactory.fiks.ks.no/artifactory/api/nuget/nuget-all
        run: |
          dotnet nuget add source $env:NUGET_ALL_REPO -n nuget-all `
            -u ${{ secrets.ARTIFACTORY_USERNAME }} `
            -p ${{ secrets.ARTIFACTORY_PASSWORD }} `
            --store-password-in-clear-text
        continue-on-error: true

      - name: Restore dependencies
        run: dotnet restore --disable-parallel --verbosity detailed

      - name: Build Debug
        run: |
          dotnet build --configuration Debug `
            --no-restore `
            --no-incremental `
            --nologo `
            ${{ needs.initialize.outputs.build-opts }}

      - name: Build Release
        run: |
          dotnet build --configuration Release `
            --no-restore `
            --no-incremental `
            --nologo `
            --verbosity detailed `
            ${{ needs.initialize.outputs.build-opts }}

      - name: Run tests
        run: |
          dotnet test `
            --configuration Release `
            --no-restore `
            --no-build `
            --logger "trx;LogFileName=results.trx" `
            --verbosity detailed

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: .NET Tests (Windows)
          path: '**/*.trx'
          reporter: dotnet-trx
          fail-on-error: false

      - name: Remove Artifactory NuGet source
        if: always()
        run: dotnet nuget remove source nuget-all
        continue-on-error: true

  push-to-nuget-org:
    name: Push to NuGet.org
    needs: [initialize, build-linux, build-windows]
    if: |
      (github.event.inputs.isRelease == 'true' || github.event.inputs.pushToNugetOrg == 'true') &&!startsWith(github.ref, 'refs/heads/dependabot/')
    runs-on: windows-latest
    
    steps:
      - name: Download NuGet packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: packages

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Push to NuGet.org
        env:
          NUGET_PUSH_REPO: https://api.nuget.org/v3/index.json
        run: |
          Get-ChildItem -Path packages -Filter *.nupkg -Recurse | ForEach-Object {
            Write-Host "Pushing $($_.FullName) to NuGet.org"
            dotnet nuget push $_.FullName `
              -k ${{ secrets.NUGET_API_KEY }} `
              -s $env:NUGET_PUSH_REPO `
              --skip-duplicate
          }

  release:
    name: Create Release and Tag
    needs: [initialize, build-linux, build-windows, push-to-nuget-org]
    if: github.event.inputs.isRelease == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}


      - name: Create and push tag
        run: |
          VERSION="${{ needs.initialize.outputs.current-version }}"
          git tag -a "v${VERSION}" -m "Release version ${VERSION}"
          git push origin "v${VERSION}"

      - name: Update version in project files
        run: |
          NEXT_VERSION="${{ needs.initialize.outputs.next-version }}"
          
          for file in $(find . -name "*.csproj" -not -path "*/Test*" -not -path "*/Example*"); do
            echo "Updating $file to version $NEXT_VERSION"
            sed -i "s/<VersionPrefix>.*<\/VersionPrefix>/<VersionPrefix>${NEXT_VERSION}<\/VersionPrefix>/" "$file"
          done

      - name: Commit and push version bump
        run: |
          NEXT_VERSION="${{ needs.initialize.outputs.next-version }}"
          git add .
          git commit -m "Bump version to ${NEXT_VERSION} [skip ci]" || echo "No changes to commit"
          git push origin HEAD:${GITHUB_REF#refs/heads/}

      - name: Download artifacts for release
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: release-packages

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.initialize.outputs.current-version }}
          name: Release ${{ needs.initialize.outputs.current-version }}
          body: |
            ## Release Notes
            ${{ github.event.inputs.releaseNotes }}
            
            ## Reviewer
            ${{ github.event.inputs.reviewer }}
            
            ## Released by
            @${{ github.actor }}
          files: |
            release-packages/**/*.nupkg
            release-packages/**/*.snupkg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}