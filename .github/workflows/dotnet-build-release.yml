permissions:
  contents: read
  checks: write

name: .NET Library Build and Release

on:
  workflow_dispatch:
    inputs:
      isRelease:
        description: 'Release build?'
        type: boolean
        required: false
        default: false
      pushToNugetOrg:
        description: 'Push to nuget.org? (for pre-release)'
        type: boolean
        required: false
        default: false
      specifiedVersion:
        description: 'Version (X.X.X) - leave empty for auto'
        required: false
        default: ''
      releaseNotes:
        description: 'Release notes'
        required: false
        default: 'No changes specified'
      reviewer:
        description: 'Reviewer name'
        required: false
        default: 'No review required'
  push:
    branches:
      - main
      - '**'

env:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: true

jobs:
  initialize:
    name: Initialize
    runs-on: ubuntu-latest
    outputs:
      current-version: ${{ steps.version.outputs.current-version }}
      next-version: ${{ steps.version.outputs.next-version }}
      full-version: ${{ steps.version.outputs.full-version }}
      build-opts: ${{ steps.version.outputs.build-opts }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - id: version
        uses: ks-no/github-actions-public/dotnet-calculate-version@main
        with:
          specified-version: ${{ github.event.inputs.specifiedVersion }}
          is-release: ${{ github.event.inputs.isRelease }}
          branch-name: ${{ github.ref_name }}
          run-number: ${{ github.run_number }}

  build-linux:
    name: Build (Linux)
    needs: initialize
    runs-on: ubuntu-latest
    timeout-minutes: 90
    concurrency:
      group: integration-tests
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: true

      - name: Build and Test
        uses: ks-no/github-actions-public/dotnet-build-and-test@main
        with:
          build-opts: ${{ needs.initialize.outputs.build-opts }}
          artifactory-username: ${{ secrets.ARTIFACTORY_USERNAME }}
          artifactory-password: ${{ secrets.ARTIFACTORY_PASSWORD }}

      - name: Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Tests (Linux)
          path: '**/*.trx'
          reporter: dotnet-trx
          fail-on-error: false

      - name: Generate SBOM
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: ks-no/github-actions-public/dotnet-generate-sbom@main
        with:
          version: ${{ needs.initialize.outputs.full-version }}

      - name: Upload SBOM
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: bom.json
          if-no-files-found: ignore

      - name: Sign Packages
        uses: ks-no/github-actions-public/dotnet-sign-nuget-packages@main
        with:
          certificate-base64: ${{ secrets.CODE_SIGN_CERT_BASE64 }}
          certificate-password: ${{ secrets.CODE_SIGN_PFX_PASS }}

      - name: Upload Packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages
          path: |
            **/Release/*.nupkg
            **/Release/*.snupkg
          if-no-files-found: error

      - name: Push to Artifactory
        uses: ks-no/github-actions-public/dotnet-push-to-artifactory@main
        with:
          artifactory-username: ${{ secrets.ARTIFACTORY_USERNAME }}
          artifactory-password: ${{ secrets.ARTIFACTORY_PASSWORD }}

      - id: setup-github-app
        uses: ks-no/github-actions-public/setup-github-app@main
        with:
          ks_github_app_id: ${{ vars.KS_RUNNER_APP_ID }}
          ks_github_app_private_key: ${{ secrets.KS_RUNNER_PRIVATE_KEY }}

      - name: Trigger and Wait for Integration Tests
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.setup-github-app.outputs.app_token }}
          script: |
            const owner = 'ks-no';
            const repo = 'fiks-io-client-dotnet-integration-tests';
            const workflowId = 'dotnet-component-test-pipeline-windows.yml';
            const componentVersion = '${{ needs.initialize.outputs.full-version }}';

            const dispatchedAt = new Date();
            console.log(`Triggering integration tests with version: ${componentVersion}`);
            await github.rest.actions.createWorkflowDispatch({
              owner, repo,
              workflow_id: workflowId,
              ref: 'master',
              inputs: {
                componentVersion,
                componentPackageName: 'KS.Fiks.IO.Client'
              }
            });

            // Wait for the run to appear
            await new Promise(r => setTimeout(r, 10000));
            let runId = null, runUrl = null;
            for (let i = 0; i < 18; i++) {
              const { data } = await github.rest.actions.listWorkflowRuns({
                owner, repo, workflow_id: workflowId,
                created: `>=${dispatchedAt.toISOString()}`,
                per_page: 5
              });
              if (data.workflow_runs.length > 0) {
                runId = data.workflow_runs[0].id;
                runUrl = data.workflow_runs[0].html_url;
                console.log(`Found run: ${runUrl}`);
                break;
              }
              console.log(`Run not found yet, retrying... (${i + 1}/18)`);
              await new Promise(r => setTimeout(r, 10000));
            }
            if (!runId) {
              core.setFailed('Could not find the triggered workflow run after 3 minutes');
              return;
            }

            // Poll until completed
            const maxWaitMs = 15 * 60 * 1000;
            const pollIntervalMs = 30 * 1000;
            const startTime = Date.now();
            while (Date.now() - startTime < maxWaitMs) {
              const { data: run } = await github.rest.actions.getWorkflowRun({
                owner, repo, run_id: runId
              });
              const elapsed = Math.round((Date.now() - startTime) / 1000);
              console.log(`Status: ${run.status} (elapsed: ${elapsed}s)`);
              if (run.status === 'completed') {
                console.log(`Conclusion: ${run.conclusion} â€” ${run.html_url}`);
                if (run.conclusion !== 'success') {
                  core.setFailed(`Integration tests failed: ${run.conclusion}. See ${run.html_url}`);
                }
                return;
              }
              await new Promise(r => setTimeout(r, pollIntervalMs));
            }
            core.setFailed(`Integration tests did not complete within 15 minutes. See ${runUrl}`);

  build-windows:
    name: Build (Windows)
    needs: initialize
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: true

      - name: Build and Test
        uses: ks-no/github-actions-public/dotnet-build-and-test@main
        with:
          build-opts: ${{ needs.initialize.outputs.build-opts }}
          artifactory-username: ${{ secrets.ARTIFACTORY_USERNAME }}
          artifactory-password: ${{ secrets.ARTIFACTORY_PASSWORD }}
          restore-args: '--disable-parallel --verbosity detailed'
          test-verbosity: 'detailed'

      - name: Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Tests (Windows)
          path: '**/*.trx'
          reporter: dotnet-trx
          fail-on-error: false

  push-nuget-org:
    name: Push to NuGet.org
    needs: [initialize, build-linux, build-windows]
    if: |
      (github.event.inputs.isRelease == 'true' || github.event.inputs.pushToNugetOrg == 'true') &&
      !startsWith(github.ref, 'refs/heads/dependabot/')
    runs-on: windows-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: packages

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - uses: ks-no/github-actions-public/dotnet-push-to-nuget-org@main
        with:
          api-key: ${{ secrets.NUGET_API_KEY }}
          package-path: packages

  release:
    name: Release
    needs: [initialize, build-linux, build-windows, push-nuget-org]
    if: github.event.inputs.isRelease == 'true' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          submodules: true

      - uses: actions/download-artifact@v4
        with:
          name: nuget-packages
          path: release-packages

      - uses: ks-no/github-actions-public/create-github-release@main
        with:
          current-version: ${{ needs.initialize.outputs.current-version }}
          next-version: ${{ needs.initialize.outputs.next-version }}
          release-notes: ${{ github.event.inputs.releaseNotes }}
          reviewer: ${{ github.event.inputs.reviewer }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          actor: ${{ github.actor }}
          ref-name: ${{ github.ref_name }}
